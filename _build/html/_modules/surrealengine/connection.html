<!DOCTYPE html>
<html class="no-js" lang="en" data-content_root="../../">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>surrealengine.connection &mdash; SurrealEngine Documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/dist/theme.css?v=310cf088" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b3bfdae7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b3bfdae7" />
            <link rel="index" title="Index" href="../../genindex.html" />
            <link rel="search" title="Search" href="../../search.html" />
            <link rel="top" title="SurrealEngine Documentation" href="#" />
            <link rel="up" title="Module code" href="../index.html" />
    </head>
<body>
    <script type="text/javascript" src="../../_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="../../search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial: Building a Blog Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connection_management.html">Connection Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connections_observability.html">Connections, Pooling, and Observability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../document_models.html">Document Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../field_types.html">Field Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../querying.html">Querying</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relationships.html">Relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schema_management.html">Schema Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signals.html">Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../materialized_views.html">Materialized Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../live.html">LIVE Queries (Subscriptions)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance.html">Performance Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/connection.html">Connection API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/document.html">Document API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/fields.html">Field Types API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/query.html">Query Building and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/schema.html">Schema API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/signals.html">Signals API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/materialized_view.html">Materialized Views API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/aggregation.html">Aggregation Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/utilities.html">Utilities API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples/basic_usage.html">basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/async_operations.html">async operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/relationships.html">relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/advanced_queries.html">advanced queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/schema_migrations.html">schema migrations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="../../index.html">Docs</a></li>
            <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
        <li class="breadcrumb-item active" aria-current="page">surrealengine.connection</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/iristech-systems/surrealengine_modules/surrealengine/connection" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <h1>Source code for surrealengine.connection</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Connection management for SurrealDB with pooling and registry support.</span>

<span class="sd">This module provides connection classes for both synchronous and asynchronous</span>
<span class="sd">operations with SurrealDB. It includes connection pooling, retry logic,</span>
<span class="sd">and a global connection registry for managing multiple database connections.</span>

<span class="sd">Classes:</span>
<span class="sd">    ConnectionPoolBase: Abstract base class for connection pools</span>
<span class="sd">    AsyncConnectionPool: Asynchronous connection pool implementation</span>
<span class="sd">    SyncConnectionPool: Synchronous connection pool implementation</span>
<span class="sd">    BaseSurrealEngineConnection: Base connection interface</span>
<span class="sd">    SurrealEngineAsyncConnection: Asynchronous connection manager</span>
<span class="sd">    SurrealEngineSyncConnection: Synchronous connection manager</span>
<span class="sd">    ConnectionRegistry: Global registry for managing connections</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">surrealdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">runtime_checkable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextvars</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextVar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.schemaless</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurrealEngine</span>

<span class="c1"># Set up logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Optional OpenTelemetry</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span> <span class="k">as</span> <span class="n">_otel_trace</span>  <span class="c1"># type: ignore</span>
    <span class="n">_otel_tracer</span> <span class="o">=</span> <span class="n">_otel_trace</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="s2">&quot;surrealengine.connection&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">_otel_trace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_otel_tracer</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_span</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_otel_tracer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="kc">None</span>
        <span class="k">return</span>
    <span class="n">span</span> <span class="o">=</span> <span class="n">_otel_tracer</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">span</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># ContextVar-backed default connection (per-task)</span>
<span class="n">_default_connection_var</span><span class="p">:</span> <span class="n">ContextVar</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s2">&quot;surrealengine_default_connection&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">set_default_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set per-task default connection using ContextVar.&quot;&quot;&quot;</span>
    <span class="n">_default_connection_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_default_connection</span><span class="p">(</span><span class="n">async_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get default connection preferring ContextVar, else global registry.</span>
<span class="sd">    Falls back to ConnectionRegistry.get_default_connection to preserve existing behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_default_connection_var</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">,</span> <span class="n">SurrealEngineSyncConnection</span>  <span class="c1"># local import to avoid circular</span>
        <span class="k">if</span> <span class="n">async_mode</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">conn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">async_mode</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">SurrealEngineSyncConnection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">conn</span>
    <span class="c1"># Fallback to global registry</span>
    <span class="k">return</span> <span class="n">ConnectionRegistry</span><span class="o">.</span><span class="n">get_default_connection</span><span class="p">(</span><span class="n">async_mode</span><span class="o">=</span><span class="n">async_mode</span><span class="p">)</span>

<div class="viewcode-block" id="ConnectionPoolBase">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionPoolBase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for connection pools.</span>

<span class="sd">    This abstract class defines the common interface and functionality for</span>
<span class="sd">    both synchronous and asynchronous connection pools.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        url: The URL of the SurrealDB server</span>
<span class="sd">        namespace: The namespace to use</span>
<span class="sd">        database: The database to use</span>
<span class="sd">        username: The username for authentication</span>
<span class="sd">        password: The password for authentication</span>
<span class="sd">        pool_size: Maximum number of connections in the pool</span>
<span class="sd">        max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">        connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">        operation_timeout: Timeout in seconds for operations</span>
<span class="sd">        retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">        retry_delay: Initial delay in seconds between retries</span>
<span class="sd">        retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">        validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConnectionPoolBase.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                 <span class="n">max_idle_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> 
                 <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">operation_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
                 <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> 
                 <span class="n">validate_on_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">health_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new ConnectionPoolBase.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL of the SurrealDB server</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>
<span class="sd">            username: The username for authentication</span>
<span class="sd">            password: The password for authentication</span>
<span class="sd">            pool_size: Maximum number of connections in the pool</span>
<span class="sd">            max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">            connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">            operation_timeout: Timeout in seconds for operations</span>
<span class="sd">            retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">            retry_delay: Initial delay in seconds between retries</span>
<span class="sd">            retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">            validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_idle_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">operation_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retry_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_backoff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span> <span class="o">=</span> <span class="n">validate_on_borrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_check_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">health_check_interval</span><span class="p">))</span>

        <span class="c1"># Initialize pool statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.create_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.create_connection">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.validate_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.validate_connection">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to validate</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the connection is valid, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.close_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.close_connection">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to close</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.get_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.get_connection">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a connection from the pool.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A connection from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.return_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.return_connection">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a connection to the pool.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ConnectionPoolBase.close">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionPoolBase.close">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the pool and all connections.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="SyncConnectionPool">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SyncConnectionPool</span><span class="p">(</span><span class="n">ConnectionPoolBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronous connection pool for SurrealDB.</span>

<span class="sd">    This class manages a pool of synchronous connections to a SurrealDB database.</span>
<span class="sd">    It handles connection creation, validation, and reuse, and provides methods</span>
<span class="sd">    for acquiring and releasing connections.</span>

<span class="sd">    The connections returned by this pool are wrapped in SurrealEngineSyncConnection</span>
<span class="sd">    objects, which can be used with the Document class and other SurrealEngine</span>
<span class="sd">    functionality that expects a SurrealEngineSyncConnection.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pool: Queue of available connections</span>
<span class="sd">        in_use: Set of connections currently in use</span>
<span class="sd">        lock: Lock for thread-safe operations</span>
<span class="sd">        closed: Whether the pool is closed</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SyncConnectionPool.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                 <span class="n">max_idle_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> 
                 <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">operation_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
                 <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> 
                 <span class="n">validate_on_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">health_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new SyncConnectionPool.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL of the SurrealDB server</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>
<span class="sd">            username: The username for authentication</span>
<span class="sd">            password: The password for authentication</span>
<span class="sd">            pool_size: Maximum number of connections in the pool</span>
<span class="sd">            max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">            connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">            operation_timeout: Timeout in seconds for operations</span>
<span class="sd">            retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">            retry_delay: Initial delay in seconds between retries</span>
<span class="sd">            retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">            validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> 
            <span class="n">pool_size</span><span class="p">,</span> <span class="n">max_idle_time</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="p">,</span> <span class="n">operation_timeout</span><span class="p">,</span> 
            <span class="n">retry_limit</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">,</span> <span class="n">validate_on_borrow</span><span class="p">,</span>
            <span class="n">health_check_interval</span><span class="o">=</span><span class="n">health_check_interval</span>
        <span class="p">)</span>

        <span class="c1"># Initialize the pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Connection -&gt; timestamp when borrowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Health check config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_health_check_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="SyncConnectionPool.create_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.create_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new connection wrapped in SurrealEngineSyncConnection</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the connection cannot be created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a SurrealEngineSyncConnection</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">SurrealEngineSyncConnection</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span>
            <span class="p">)</span>

            <span class="c1"># Connect to the database</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new connection (total created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">connection</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="SyncConnectionPool.validate_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.validate_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to validate (SurrealEngineSyncConnection)</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the connection is valid, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Execute a simple query to check if the connection is valid</span>
            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT 1 FROM information_schema.tables LIMIT 1&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SyncConnectionPool.close_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.close_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to close (SurrealEngineSyncConnection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed connection (total discarded: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to close connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SyncConnectionPool.get_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.get_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a connection from the pool.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SurrealEngineSyncConnection from the pool</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the pool is closed</span>
<span class="sd">            Exception: If a connection cannot be obtained</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection pool is closed&quot;</span><span class="p">)</span>

        <span class="c1"># Try to get a connection from the pool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Update available last used tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Validate the connection if needed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
                <span class="c1"># Connection is invalid, close it and create a new one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># Pool is empty, create a new connection if we haven&#39;t reached the limit</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Wait for a connection to become available</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_timeout</span><span class="p">)</span>

                        <span class="c1"># Validate the connection if needed</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
                            <span class="c1"># Connection is invalid, close it and create a new one</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for a connection&quot;</span><span class="p">)</span>

        <span class="c1"># Mark the connection as in use</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Borrowed connection (total borrowed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="SyncConnectionPool.return_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.return_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a connection to the pool.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to return (SurrealEngineSyncConnection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="c1"># Pool is closed, just close the connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Remove the connection from the in-use set</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returned connection (total returned: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Connection wasn&#39;t borrowed from this pool</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempted to return a connection that wasn&#39;t borrowed from this pool&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Check if the connection is still valid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
            <span class="c1"># Connection is invalid, close it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Return the connection to the pool</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Pool is full, close the connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span></div>


<div class="viewcode-block" id="SyncConnectionPool.close">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SyncConnectionPool.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the pool and all connections.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># stop health thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># Close all connections in the pool</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Close all in-use connections</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection pool closed. Stats: created=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;borrowed=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span><span class="si">}</span><span class="s2">, returned=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;discarded=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_health_check_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Background thread to prune stale available connections and validate pool.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">health_check_interval</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prune_idle_available</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Health check error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prune_idle_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">kept</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Drain all available connections non-blocking</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span><span class="p">:</span>
                    <span class="c1"># prune</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kept</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># Requeue kept</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">kept</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span></div>



<div class="viewcode-block" id="AsyncConnectionPool">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AsyncConnectionPool</span><span class="p">(</span><span class="n">ConnectionPoolBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronous connection pool for SurrealDB.</span>

<span class="sd">    This class manages a pool of asynchronous connections to a SurrealDB database.</span>
<span class="sd">    It handles connection creation, validation, and reuse, and provides methods</span>
<span class="sd">    for acquiring and releasing connections.</span>

<span class="sd">    The connections returned by this pool are wrapped in SurrealEngineAsyncConnection</span>
<span class="sd">    objects, which can be used with the Document class and other SurrealEngine</span>
<span class="sd">    functionality that expects a SurrealEngineAsyncConnection.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pool: List of available connections</span>
<span class="sd">        in_use: Dictionary of connections currently in use and their timestamps</span>
<span class="sd">        lock: Asyncio lock for thread-safe operations</span>
<span class="sd">        closed: Whether the pool is closed</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AsyncConnectionPool.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                 <span class="n">max_idle_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> 
                 <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">operation_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
                 <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> 
                 <span class="n">validate_on_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">health_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new AsyncConnectionPool.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL of the SurrealDB server</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>
<span class="sd">            username: The username for authentication</span>
<span class="sd">            password: The password for authentication</span>
<span class="sd">            pool_size: Maximum number of connections in the pool</span>
<span class="sd">            max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">            connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">            operation_timeout: Timeout in seconds for operations</span>
<span class="sd">            retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">            retry_delay: Initial delay in seconds between retries</span>
<span class="sd">            retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">            validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> 
            <span class="n">pool_size</span><span class="p">,</span> <span class="n">max_idle_time</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="p">,</span> <span class="n">operation_timeout</span><span class="p">,</span> 
            <span class="n">retry_limit</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">,</span> <span class="n">validate_on_borrow</span><span class="p">,</span>
            <span class="n">health_check_interval</span><span class="o">=</span><span class="n">health_check_interval</span>
        <span class="p">)</span>

        <span class="c1"># Initialize the pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Connection -&gt; timestamp when borrowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Health checker</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_health_task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_health_check_loop</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_health_task</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.create_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.create_connection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new connection wrapped in SurrealEngineAsyncConnection</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the connection cannot be created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a SurrealEngineAsyncConnection</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span>
            <span class="p">)</span>

            <span class="c1"># Connect to the database</span>
            <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created new async connection (total created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">connection</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create async connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.validate_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.validate_connection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to validate (SurrealEngineAsyncConnection)</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the connection is valid, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Execute a simple query to check if the connection is valid</span>
            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;SELECT 1 FROM information_schema.tables LIMIT 1&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async connection validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.close_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.close_connection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close a connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to close (SurrealEngineAsyncConnection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed async connection (total discarded: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to close async connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.get_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.get_connection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a connection from the pool.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SurrealEngineAsyncConnection from the pool</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the pool is closed</span>
<span class="sd">            Exception: If a connection cannot be obtained</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Async connection pool is closed&quot;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Try to get a connection from the pool</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="c1"># Update available last used tracking</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Validate the connection if needed</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span><span class="p">:</span>
                    <span class="n">is_valid</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                        <span class="c1"># Connection is invalid, close it and create a new one</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">:</span>
                <span class="c1"># Pool is empty but we haven&#39;t reached the limit, create a new connection</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We&#39;ve reached the pool size limit, wait for a connection to be returned</span>
                <span class="n">waiter</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waiter</span><span class="p">)</span>

                <span class="c1"># Release the lock while waiting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Wait for a connection with timeout</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">waiter</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_timeout</span><span class="p">)</span>

                    <span class="c1"># Validate the connection if needed</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span><span class="p">:</span>
                        <span class="n">is_valid</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                            <span class="c1"># Connection is invalid, close it and create a new one</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                                <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connection</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                    <span class="c1"># Remove the waiter from the list</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">waiter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">waiter</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for an async connection&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Remove the waiter from the list</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">waiter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">waiter</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># Re-acquire the lock</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="c1"># Mark the connection as in use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Borrowed async connection (total borrowed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.return_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.return_connection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">return_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a connection to the pool.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to return (SurrealEngineAsyncConnection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="c1"># Pool is closed, just close the connection</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Remove the connection from the in-use set</span>
            <span class="k">if</span> <span class="n">connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returned async connection (total returned: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Connection wasn&#39;t borrowed from this pool</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempted to return an async connection that wasn&#39;t borrowed from this pool&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Check if there are waiters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="p">:</span>
                <span class="c1"># Give the connection to the first waiter</span>
                <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">waiter</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">waiter</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># Check if the connection is still valid</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span><span class="p">:</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                    <span class="c1"># Connection is invalid, close it</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># Return the connection to the pool</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Pool is full, close the connection</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span></div>


<div class="viewcode-block" id="AsyncConnectionPool.close">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.AsyncConnectionPool.close">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the pool and all connections.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Cancel background health task</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_health_task&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_health_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Cancel all waiters</span>
            <span class="k">for</span> <span class="n">waiter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">waiter</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">waiter</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Async connection pool is closed&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_waiters</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Close all connections in the pool</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># Close all in-use connections</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_use</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async connection pool closed. Stats: created=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_connections</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;borrowed=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">borrowed_connections</span><span class="si">}</span><span class="s2">, returned=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">returned_connections</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;discarded=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discarded_connections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_health_check_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Background task to prune stale available connections and validate pool.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_idle_available</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async health check error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">health_check_interval</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># Task is being cancelled during shutdown</span>
            <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_prune_idle_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">kept</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># We need to pop all currently available connections and decide whether to keep or close</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Drain available list into a temp list to examine without holding them in pool</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="c1"># Decide pruning</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span><span class="p">:</span>
                    <span class="c1"># Exceeded idle time; schedule for close outside of lock</span>
                    <span class="n">kept</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">conn</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>  <span class="c1"># False -&gt; should close</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kept</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">conn</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>   <span class="c1"># True -&gt; keep</span>
        <span class="c1"># Now process closes and requeue kept without holding the lock</span>
        <span class="n">requeue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conn</span><span class="p">,</span> <span class="n">keep</span> <span class="ow">in</span> <span class="n">kept</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">requeue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="c1"># Requeue kept connections and refresh last used timestamps</span>
        <span class="k">if</span> <span class="n">requeue</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">requeue</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_available_last_used</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span></div>



<div class="viewcode-block" id="ConnectionEvent">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEvent">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Event types for connection events.</span>

<span class="sd">    This class defines the event types that can be emitted by connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CONNECTED</span> <span class="o">=</span> <span class="s2">&quot;connected&quot;</span>
    <span class="n">DISCONNECTED</span> <span class="o">=</span> <span class="s2">&quot;disconnected&quot;</span>
    <span class="n">RECONNECTING</span> <span class="o">=</span> <span class="s2">&quot;reconnecting&quot;</span>
    <span class="n">RECONNECTED</span> <span class="o">=</span> <span class="s2">&quot;reconnected&quot;</span>
    <span class="n">CONNECTION_FAILED</span> <span class="o">=</span> <span class="s2">&quot;connection_failed&quot;</span>
    <span class="n">RECONNECTION_FAILED</span> <span class="o">=</span> <span class="s2">&quot;reconnection_failed&quot;</span>
    <span class="n">CONNECTION_CLOSED</span> <span class="o">=</span> <span class="s2">&quot;connection_closed&quot;</span></div>



<div class="viewcode-block" id="ConnectionEventListener">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventListener">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionEventListener</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Listener for connection events.</span>

<span class="sd">    This class defines the interface for connection event listeners.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConnectionEventListener.on_event">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventListener.on_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a connection event.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_type: The type of event</span>
<span class="sd">            connection: The connection that emitted the event</span>
<span class="sd">            **kwargs: Additional event data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="ConnectionEventEmitter">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventEmitter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionEventEmitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Emitter for connection events.</span>

<span class="sd">    This class provides methods for registering listeners and emitting events.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        listeners: List of registered event listeners</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConnectionEventEmitter.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventEmitter.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new ConnectionEventEmitter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConnectionEventListener</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ConnectionEventEmitter.add_listener">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventEmitter.add_listener">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="n">ConnectionEventListener</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a listener for connection events.</span>

<span class="sd">        Args:</span>
<span class="sd">            listener: The listener to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">listener</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConnectionEventEmitter.remove_listener">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventEmitter.remove_listener">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="n">ConnectionEventListener</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a listener for connection events.</span>

<span class="sd">        Args:</span>
<span class="sd">            listener: The listener to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">listener</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConnectionEventEmitter.emit_event">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionEventEmitter.emit_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">emit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Emit a connection event.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_type: The type of event</span>
<span class="sd">            connection: The connection that emitted the event</span>
<span class="sd">            **kwargs: Additional event data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">listener</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in connection event listener: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OperationQueue">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OperationQueue</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Queue for operations during reconnection with backpressure and metrics.</span>

<span class="sd">    This class manages a queue of operations that are waiting for a connection</span>
<span class="sd">    to be reestablished. Once the connection is restored, the operations are</span>
<span class="sd">    executed in the order they were queued.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        sync_operations: Queue of synchronous operations</span>
<span class="sd">        async_operations: Queue of asynchronous operations</span>
<span class="sd">        is_reconnecting: Whether the connection is currently reconnecting</span>
<span class="sd">        reconnection_event: Event that is set when reconnection is complete</span>
<span class="sd">        async_reconnection_event: Asyncio event that is set when reconnection is complete</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OperationQueue.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drop_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;block&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new OperationQueue.</span>
<span class="sd">        Args:</span>
<span class="sd">            maxsize: Maximum queued operations per list (0 = unbounded)</span>
<span class="sd">            drop_policy: One of &#39;block&#39; | &#39;drop_oldest&#39; | &#39;error&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnection_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_reconnection_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxsize</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">=</span> <span class="n">drop_policy</span>
        <span class="c1"># Metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;queued&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;drained&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="OperationQueue.start_reconnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.start_reconnection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_reconnection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the reconnection process.</span>

<span class="sd">        This method marks the connection as reconnecting and clears the</span>
<span class="sd">        reconnection events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnection_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_reconnection_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="OperationQueue.end_reconnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.end_reconnection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">end_reconnection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End the reconnection process.</span>

<span class="sd">        This method marks the connection as no longer reconnecting and sets</span>
<span class="sd">        the reconnection events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnection_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_reconnection_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="OperationQueue.queue_operation">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.queue_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">queue_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue a synchronous operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            operation: The operation to queue</span>
<span class="sd">            args: The positional arguments for the operation</span>
<span class="sd">            kwargs: The keyword arguments for the operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Enforce backpressure policy for sync operations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;drop_oldest&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;OperationQueue full (sync) and drop_policy=error&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
                <span class="c1"># Busy-wait simple block until space available</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;queued&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="OperationQueue.queue_async_operation">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.queue_async_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">queue_async_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue an asynchronous operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            operation: The operation to queue</span>
<span class="sd">            args: The positional arguments for the operation</span>
<span class="sd">            kwargs: The keyword arguments for the operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Enforce backpressure policy for async operations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;drop_oldest&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;OperationQueue full (async) and drop_policy=error&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_policy</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
                <span class="c1"># Busy-wait simple block until space available</span>
                <span class="c1"># Use asyncio.sleep if running in an event loop</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_spin</span><span class="p">():</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_spin</span><span class="p">())</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c1"># schedule/cancel just to ensure loop exists</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="c1"># No running loop; fallback to time.sleep</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;queued&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="OperationQueue.execute_queued_operations">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.execute_queued_operations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_queued_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute all queued synchronous operations.&quot;&quot;&quot;</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_operations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">operation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing queued operation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;drained&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span></div>


<div class="viewcode-block" id="OperationQueue.execute_queued_async_operations">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.execute_queued_async_operations">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_queued_async_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute all queued asynchronous operations.&quot;&quot;&quot;</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_operations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">operation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing queued async operation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;drained&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span></div>


<div class="viewcode-block" id="OperationQueue.wait_for_reconnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.wait_for_reconnection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_reconnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for reconnection to complete.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Maximum time to wait in seconds</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if reconnection completed, False if timed out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnection_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span></div>


<div class="viewcode-block" id="OperationQueue.wait_for_async_reconnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.OperationQueue.wait_for_async_reconnection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_async_reconnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for reconnection to complete asynchronously.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Maximum time to wait in seconds</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if reconnection completed, False if timed out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_reconnection_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_reconnection_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="ReconnectionStrategy">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ReconnectionStrategy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReconnectionStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for reconnecting to the database.</span>

<span class="sd">    This class provides methods for reconnecting to the database with</span>
<span class="sd">    configurable retry limits and backoff strategies.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_attempts: Maximum number of reconnection attempts</span>
<span class="sd">        initial_delay: Initial delay in seconds between reconnection attempts</span>
<span class="sd">        max_delay: Maximum delay in seconds between reconnection attempts</span>
<span class="sd">        backoff_factor: Backoff multiplier for reconnection delay</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReconnectionStrategy.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ReconnectionStrategy.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">initial_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
                 <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new ReconnectionStrategy.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_attempts: Maximum number of reconnection attempts</span>
<span class="sd">            initial_delay: Initial delay in seconds between reconnection attempts</span>
<span class="sd">            max_delay: Maximum delay in seconds between reconnection attempts</span>
<span class="sd">            backoff_factor: Backoff multiplier for reconnection delay</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">initial_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_delay</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="p">)</span></div>


<div class="viewcode-block" id="ReconnectionStrategy.get_delay">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ReconnectionStrategy.get_delay">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the delay for a reconnection attempt.</span>

<span class="sd">        Args:</span>
<span class="sd">            attempt: The reconnection attempt number (0-based)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The delay in seconds for the reconnection attempt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_delay</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RetryStrategy">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RetryStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for retrying operations with exponential backoff.</span>

<span class="sd">    This class provides methods for retrying operations with configurable</span>
<span class="sd">    retry limits and backoff strategies.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        retry_limit: Maximum number of retries</span>
<span class="sd">        retry_delay: Initial delay in seconds between retries</span>
<span class="sd">        retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RetryStrategy.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new RetryStrategy.</span>

<span class="sd">        Args:</span>
<span class="sd">            retry_limit: Maximum number of retries</span>
<span class="sd">            retry_delay: Initial delay in seconds between retries</span>
<span class="sd">            retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retry_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_backoff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetryStrategy.get_retry_delay">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy.get_retry_delay">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_retry_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the delay for a retry attempt.</span>

<span class="sd">        Args:</span>
<span class="sd">            attempt: The retry attempt number (0-based)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The delay in seconds for the retry attempt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_backoff</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetryStrategy.should_retry">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy.should_retry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether to retry an operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            attempt: The retry attempt number (0-based)</span>
<span class="sd">            exception: The exception that caused the operation to fail</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the operation should be retried, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Don&#39;t retry if we&#39;ve reached the retry limit</span>
        <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Determine whether the exception is retryable</span>
        <span class="c1"># For now, we&#39;ll retry on all exceptions, but in a real implementation</span>
        <span class="c1"># you might want to be more selective</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="RetryStrategy.execute_with_retry">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy.execute_with_retry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute an operation with retry.</span>

<span class="sd">        Args:</span>
<span class="sd">            operation: The operation to execute</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the operation</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the operation fails after all retries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">operation</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_retry</span><span class="p">(</span><span class="n">attempt</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate the delay for this retry attempt</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_retry_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>

                <span class="c1"># Wait before retrying</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="c1"># If we get here, all retries failed</span>
        <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">last_exception</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">last_exception</span>

        <span class="c1"># This should never happen, but just in case</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Operation failed for unknown reason&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetryStrategy.execute_with_retry_async">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.RetryStrategy.execute_with_retry_async">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_with_retry_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute an asynchronous operation with retry.</span>

<span class="sd">        Args:</span>
<span class="sd">            operation: The asynchronous operation to execute</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the operation</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the operation fails after all retries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">operation</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_retry</span><span class="p">(</span><span class="n">attempt</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate the delay for this retry attempt</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_retry_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async operation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>

                <span class="c1"># Wait before retrying</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="c1"># If we get here, all retries failed</span>
        <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async operation failed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">last_exception</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">last_exception</span>

        <span class="c1"># This should never happen, but just in case</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Async operation failed for unknown reason&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="parse_connection_string">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.parse_connection_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_connection_string</span><span class="p">(</span><span class="n">connection_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a connection string into a dictionary of connection parameters.</span>

<span class="sd">    Supports the following formats:</span>
<span class="sd">    - surrealdb://user:pass@host:port/namespace/database?param1=value1&amp;param2=value2 (maps to ws://)</span>
<span class="sd">    - wss://user:pass@host:port/namespace/database?param1=value1&amp;param2=value2</span>
<span class="sd">    - ws://user:pass@host:port/namespace/database?param1=value1&amp;param2=value2</span>
<span class="sd">    - http://user:pass@host:port/namespace/database?param1=value1&amp;param2=value2</span>
<span class="sd">    - https://user:pass@host:port/namespace/database?param1=value1&amp;param2=value2</span>

<span class="sd">    Connection string parameters:</span>
<span class="sd">    - pool_size: Maximum number of connections in the pool (default: 10)</span>
<span class="sd">    - max_idle_time: Maximum time in seconds a connection can be idle before being closed (default: 60)</span>
<span class="sd">    - connect_timeout: Timeout in seconds for establishing a connection (default: 30)</span>
<span class="sd">    - operation_timeout: Timeout in seconds for operations (default: 30)</span>
<span class="sd">    - retry_limit: Maximum number of retries for failed operations (default: 3)</span>
<span class="sd">    - retry_delay: Initial delay in seconds between retries (default: 1)</span>
<span class="sd">    - retry_backoff: Backoff multiplier for retry delay (default: 2)</span>
<span class="sd">    - validate_on_borrow: Whether to validate connections when borrowing from the pool (default: true)</span>

<span class="sd">    Args:</span>
<span class="sd">        connection_string: The connection string to parse</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing the parsed connection parameters</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the connection string is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the connection string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_string</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Connection string cannot be empty&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the connection string starts with a supported protocol</span>
    <span class="n">supported_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;surrealdb://&quot;</span><span class="p">,</span> <span class="s2">&quot;wss://&quot;</span><span class="p">,</span> <span class="s2">&quot;ws://&quot;</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="s2">&quot;mem://&quot;</span><span class="p">,</span> <span class="s2">&quot;surrealkv://&quot;</span><span class="p">,</span> <span class="s2">&quot;file://&quot;</span><span class="p">]</span>
    <span class="n">protocol_match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">supported_protocols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
            <span class="n">protocol_match</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">protocol_match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection string must start with one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported_protocols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the connection string using urllib.parse</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>

        <span class="c1"># Extract the components</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span>

        <span class="c1"># Handle embedded schemes which might not have host/port/auth in the same way</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mem&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="s2">&quot;surrealkv&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">):</span>
             <span class="c1"># For these, we might just want to preserve the full URL or handle path specifically</span>
             <span class="c1"># But we typically don&#39;t have user:pass@host:port unless it&#39;s surrealdb&#39;s quirky format</span>
             <span class="c1"># SDK 1.0.7+ handles these directly. </span>
             <span class="c1"># We should extract query params and return the URL as is or slightly normalized.</span>
             
             <span class="c1"># Parse query parameters</span>
             <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
             <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                 <span class="n">query_params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                         <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                             <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                         <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                             <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                         <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                             <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                         <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?\d+(\.\d+)?$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                             <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                         <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                     <span class="k">else</span><span class="p">:</span>
                         <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

             <span class="k">return</span> <span class="p">{</span>
                 <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">connection_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># Strip query params from URL passed to SDK if SDK expects them separately? </span>
                                                         <span class="c1"># Actually SDK factory usually takes full URL. </span>
                                                         <span class="c1"># But BaseSurrealEngineConnection might need clean URL.</span>
                                                         <span class="c1"># Let&#39;s pass the full base URL (scheme://path) and params separate?</span>
                                                         <span class="c1"># connection.py usually passes &quot;url&quot; to factory.</span>
                 <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Embedded typically doesn&#39;t use these or handles them differently</span>
                 <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">params</span>
             <span class="p">}</span>

        <span class="c1"># Parse the netloc to get username, password, host, and port</span>
        <span class="n">username</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="n">auth</span><span class="p">,</span> <span class="n">netloc</span> <span class="o">=</span> <span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">auth</span><span class="p">:</span>
                <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>

        <span class="c1"># Parse host and port</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">netloc</span>
        <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">netloc</span><span class="p">:</span>
             <span class="c1"># Check for ipv6 or multiple colons? urllib usually handles this but simple split might fail</span>
             <span class="c1"># Assuming standard host:port for now</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port_str</span> <span class="o">=</span> <span class="n">netloc</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># Could be IPv6 without brackets or something else</span>
                <span class="k">pass</span> 

        <span class="c1"># Parse namespace and database from path</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">database</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">path_parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Parse query parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Try to convert to appropriate types</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?\d+(\.\d+)?$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="c1"># Construct the URL</span>
        <span class="c1"># Map the surrealdb scheme to ws scheme</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;surrealdb&quot;</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="s2">&quot;ws&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="c1"># Typically regex check or simple logic for rpc</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;wss&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/rpc&#39;</span><span class="p">):</span>
             <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;/rpc&#39;</span>

        <span class="c1"># Build the result dictionary</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span>
            <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">database</span><span class="p">,</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
            <span class="o">**</span><span class="n">params</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse connection string: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseSurrealEngineConnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.BaseSurrealEngineConnection">[docs]</a>
<span class="nd">@runtime_checkable</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseSurrealEngineConnection</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol defining the interface for SurrealDB connections.</span>

<span class="sd">    This protocol defines the common interface that both synchronous and</span>
<span class="sd">    asynchronous connections must implement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">Any</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurrealEngine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dynamic table accessor.&quot;&quot;&quot;</span>
        <span class="o">...</span></div>


<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionPoolClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client that proxies requests to connections from a connection pool.</span>

<span class="sd">    This class provides the same interface as the SurrealDB client but gets a connection</span>
<span class="sd">    from the pool for each operation and returns it when done.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pool: The connection pool to get connections from</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="s1">&#39;AsyncConnectionPool&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new ConnectionPoolClient.</span>

<span class="sd">        Args:</span>
<span class="sd">            pool: The connection pool to get connections from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new record in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection: The collection to create the record in</span>
<span class="sd">            data: The data to create the record with</span>

<span class="sd">        Returns:</span>
<span class="sd">            The created record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">_maybe_span</span><span class="p">(</span><span class="s2">&quot;surreal.query&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;db.system&quot;</span><span class="p">:</span> <span class="s2">&quot;surrealdb&quot;</span><span class="p">,</span> <span class="s2">&quot;db.name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;db.namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="s2">&quot;db.operation&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;db.collection&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="p">}):</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.document</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialize_http_safe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">serialize_http_safe</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an existing record in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: The ID of the record to update</span>
<span class="sd">            data: The data to update the record with</span>

<span class="sd">        Returns:</span>
<span class="sd">            The updated record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">_maybe_span</span><span class="p">(</span><span class="s2">&quot;surreal.query&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;db.system&quot;</span><span class="p">:</span> <span class="s2">&quot;surrealdb&quot;</span><span class="p">,</span> <span class="s2">&quot;db.name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;db.namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="s2">&quot;db.operation&quot;</span><span class="p">:</span> <span class="s2">&quot;update&quot;</span><span class="p">}):</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.document</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialize_http_safe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">serialize_http_safe</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a record from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: The ID of the record to delete</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the delete operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select a record from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: The ID of the record to select</span>

<span class="sd">        Returns:</span>
<span class="sd">            The selected record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a query against the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: The query to execute</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert multiple records into the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection: The collection to insert the records into</span>
<span class="sd">            data: The data to insert</span>

<span class="sd">        Returns:</span>
<span class="sd">            The inserted records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">_maybe_span</span><span class="p">(</span><span class="s2">&quot;surreal.query&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;db.system&quot;</span><span class="p">:</span> <span class="s2">&quot;surrealdb&quot;</span><span class="p">,</span> <span class="s2">&quot;db.name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;db.namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="s2">&quot;db.operation&quot;</span><span class="p">:</span> <span class="s2">&quot;insert&quot;</span><span class="p">,</span> <span class="s2">&quot;db.collection&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;db.row_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span><span class="p">}):</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.document</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialize_http_safe</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">serialize_http_safe</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">serialize_http_safe</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">signin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign in to the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            credentials: The credentials to sign in with</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the sign-in operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">signin</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use a specific namespace and database.</span>

<span class="sd">        Args:</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the use operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">return_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the connection pool.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="ConnectionRegistry">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Global connection registry for SurrealDB.</span>

<span class="sd">    This class provides a centralized registry for managing database connections.</span>
<span class="sd">    It allows setting a default connection and registering named connections</span>
<span class="sd">    that can be retrieved throughout the application.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _default_async_connection: The default async connection to use when none is specified</span>
<span class="sd">        _default_sync_connection: The default sync connection to use when none is specified</span>
<span class="sd">        _async_connections: Dictionary of named async connections</span>
<span class="sd">        _sync_connections: Dictionary of named sync connections</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_default_async_connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_default_sync_connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_async_connections</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_sync_connections</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ConnectionRegistry.set_default_async_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.set_default_async_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_async_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default async connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The async connection to set as default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_default_async_connection</span> <span class="o">=</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.set_default_sync_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.set_default_sync_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_sync_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default sync connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The sync connection to set as default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_default_sync_connection</span> <span class="o">=</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.set_default_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.set_default_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default connection based on its type.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: The connection to set as default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">set_default_async_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">SurrealEngineSyncConnection</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">set_default_sync_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported connection type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_default_async_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_default_async_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_async_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the default async connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The default async connection</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no default async connection has been set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_async_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No default async connection has been set. Call set_default_async_connection() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_async_connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_default_sync_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_default_sync_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_sync_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the default sync connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The default sync connection</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no default sync connection has been set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_sync_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No default sync connection has been set. Call set_default_sync_connection() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_sync_connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_default_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_default_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">async_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the default connection based on the mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            async_mode: Whether to get the async or sync connection</span>

<span class="sd">        Returns:</span>
<span class="sd">            The default connection of the requested type</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no default connection of the requested type has been set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">async_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_default_async_connection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_default_sync_connection</span><span class="p">()</span></div>


<div class="viewcode-block" id="ConnectionRegistry.add_async_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.add_async_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_async_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a named async connection to the registry.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name to register the connection under</span>
<span class="sd">            connection: The async connection to register</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_async_connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.add_sync_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.add_sync_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_sync_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a named sync connection to the registry.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name to register the connection under</span>
<span class="sd">            connection: The sync connection to register</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_sync_connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span></div>


<div class="viewcode-block" id="ConnectionRegistry.add_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.add_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a named connection to the registry based on its type.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name to register the connection under</span>
<span class="sd">            connection: The connection to register</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_async_connection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">SurrealEngineSyncConnection</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_sync_connection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported connection type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_async_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_async_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_async_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a named async connection from the registry.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the async connection to retrieve</span>

<span class="sd">        Returns:</span>
<span class="sd">            The requested async connection</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If no async connection with the given name exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_async_connections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No async connection named &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; exists.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_async_connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_sync_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_sync_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sync_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a named sync connection from the registry.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the sync connection to retrieve</span>

<span class="sd">        Returns:</span>
<span class="sd">            The requested sync connection</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If no sync connection with the given name exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sync_connections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No sync connection named &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; exists.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sync_connections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="ConnectionRegistry.get_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.ConnectionRegistry.get_connection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">async_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a named connection from the registry based on the mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the connection to retrieve</span>
<span class="sd">            async_mode: Whether to get an async or sync connection</span>

<span class="sd">        Returns:</span>
<span class="sd">            The requested connection of the requested type</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If no connection of the requested type with the given name exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">async_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_async_connection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_sync_connection</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SurrealEngineAsyncConnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SurrealEngineAsyncConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronous connection manager for SurrealDB.</span>

<span class="sd">    This class manages the asynchronous connection to a SurrealDB database, providing methods</span>
<span class="sd">    for connecting, disconnecting, and executing transactions. It also provides</span>
<span class="sd">    access to the database through the db property.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        url: The URL of the SurrealDB server</span>
<span class="sd">        namespace: The namespace to use</span>
<span class="sd">        database: The database to use</span>
<span class="sd">        username: The username for authentication</span>
<span class="sd">        password: The password for authentication</span>
<span class="sd">        client: The SurrealDB async client instance or ConnectionPoolClient</span>
<span class="sd">        use_pool: Whether to use a connection pool</span>
<span class="sd">        pool: The connection pool if use_pool is True</span>
<span class="sd">        pool_size: The size of the connection pool</span>
<span class="sd">        max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SurrealEngineAsyncConnection.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">make_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_pool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_idle_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
                 <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">operation_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">validate_on_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">health_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new SurrealEngineAsyncConnection.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL of the SurrealDB server</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>
<span class="sd">            username: The username for authentication</span>
<span class="sd">            password: The password for authentication</span>
<span class="sd">            name: The name to register this connection under in the registry</span>
<span class="sd">            make_default: Whether to set this connection as the default</span>
<span class="sd">            use_pool: Whether to use a connection pool</span>
<span class="sd">            pool_size: The size of the connection pool</span>
<span class="sd">            max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">            connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">            operation_timeout: Timeout in seconds for operations</span>
<span class="sd">            retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">            retry_delay: Initial delay in seconds between retries</span>
<span class="sd">            retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">            validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pool</span> <span class="o">=</span> <span class="n">use_pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="n">pool_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span> <span class="o">=</span> <span class="n">max_idle_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_timeout</span> <span class="o">=</span> <span class="n">connect_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_timeout</span> <span class="o">=</span> <span class="n">operation_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span> <span class="o">=</span> <span class="n">retry_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_backoff</span> <span class="o">=</span> <span class="n">retry_backoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span> <span class="o">=</span> <span class="n">validate_on_borrow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_check_interval</span> <span class="o">=</span> <span class="n">health_check_interval</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">ConnectionRegistry</span><span class="o">.</span><span class="n">add_async_connection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make_default</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ConnectionRegistry</span><span class="o">.</span><span class="n">set_default_async_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="SurrealEngineAsyncConnection.__aenter__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.__aenter__">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enter the async context manager.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The connection instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="SurrealEngineAsyncConnection.__aexit__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.__aexit__">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span> 
                        <span class="n">exc_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span> 
                        <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the async context manager.</span>

<span class="sd">        Args:</span>
<span class="sd">            exc_type: The exception type, if an exception was raised</span>
<span class="sd">            exc_val: The exception value, if an exception was raised</span>
<span class="sd">            exc_tb: The exception traceback, if an exception was raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurrealEngine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dynamic table accessor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SurrealEngine instance for accessing tables dynamically</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SurrealEngine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="SurrealEngineAsyncConnection.connect">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.connect">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to the database.</span>

<span class="sd">        This method creates a new client if one doesn&#39;t exist. If use_pool is True,</span>
<span class="sd">        it creates a connection pool and a ConnectionPoolClient. Otherwise, it creates</span>
<span class="sd">        a direct connection to the database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The SurrealDB client instance or ConnectionPoolClient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pool</span><span class="p">:</span>
                <span class="c1"># Create a connection pool</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">AsyncConnectionPool</span><span class="p">(</span>
                    <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                    <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">pool_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_size</span><span class="p">,</span>
                    <span class="n">max_idle_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_idle_time</span><span class="p">,</span>
                    <span class="n">connect_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_timeout</span><span class="p">,</span>
                    <span class="n">operation_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_timeout</span><span class="p">,</span>
                    <span class="n">retry_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_limit</span><span class="p">,</span>
                    <span class="n">retry_delay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="p">,</span>
                    <span class="n">retry_backoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_backoff</span><span class="p">,</span>
                    <span class="n">validate_on_borrow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_on_borrow</span><span class="p">,</span>
                    <span class="n">health_check_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">health_check_interval</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Create a client that uses the pool</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">ConnectionPoolClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create the client directly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">surrealdb</span><span class="o">.</span><span class="n">AsyncSurreal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

                <span class="c1"># Sign in if credentials are provided</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">signin</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">})</span>

                <span class="c1"># Use namespace and database</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span></div>


<div class="viewcode-block" id="SurrealEngineAsyncConnection.disconnect">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.disconnect">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disconnect from the database.</span>

<span class="sd">        This method closes the client connection if one exists. If use_pool is True,</span>
<span class="sd">        it closes the connection pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pool</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SurrealEngineAsyncConnection.transaction">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineAsyncConnection.transaction">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coroutines</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute multiple operations in a transaction.</span>

<span class="sd">        This method executes a list of coroutines within a transaction,</span>
<span class="sd">        committing the transaction if all operations succeed or canceling</span>
<span class="sd">        it if any operation fails.</span>

<span class="sd">        Args:</span>
<span class="sd">            coroutines: List of coroutines to execute in the transaction</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of results from the coroutines</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If any operation in the transaction fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">_maybe_span</span><span class="p">(</span><span class="s2">&quot;surreal.transaction&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;db.system&quot;</span><span class="p">:</span> <span class="s2">&quot;surrealdb&quot;</span><span class="p">,</span> <span class="s2">&quot;db.name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;db.namespace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="s2">&quot;db.operation&quot;</span><span class="p">:</span> <span class="s2">&quot;transaction&quot;</span><span class="p">}):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;BEGIN TRANSACTION;&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coro</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;COMMIT TRANSACTION;&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CANCEL TRANSACTION;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span></div>
</div>



<div class="viewcode-block" id="create_connection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.create_connection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_connection</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                  <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                  <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">make_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">async_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">use_pool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                  <span class="n">max_idle_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                  <span class="n">operation_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                  <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">retry_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="n">validate_on_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">auto_connect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">health_check_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;SurrealEngineAsyncConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory function to create a connection of the appropriate type.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: The URL of the SurrealDB server</span>
<span class="sd">        namespace: The namespace to use</span>
<span class="sd">        database: The database to use</span>
<span class="sd">        username: The username for authentication</span>
<span class="sd">        password: The password for authentication</span>
<span class="sd">        name: The name to register this connection under in the registry</span>
<span class="sd">        make_default: Whether to set this connection as the default</span>
<span class="sd">        async_mode: Whether to create an async or sync connection</span>
<span class="sd">        use_pool: Whether to use a connection pool (async_mode only)</span>
<span class="sd">        pool_size: The size of the connection pool</span>
<span class="sd">        max_idle_time: Maximum time in seconds a connection can be idle before being closed</span>
<span class="sd">        connect_timeout: Timeout in seconds for establishing a connection</span>
<span class="sd">        operation_timeout: Timeout in seconds for operations</span>
<span class="sd">        retry_limit: Maximum number of retries for failed operations</span>
<span class="sd">        retry_delay: Initial delay in seconds between retries</span>
<span class="sd">        retry_backoff: Backoff multiplier for retry delay</span>
<span class="sd">        validate_on_borrow: Whether to validate connections when borrowing from the pool</span>
<span class="sd">        auto_connect: Whether to automatically connect the connection</span>
<span class="sd">        health_check_interval: Background health check interval (seconds) for pools</span>

<span class="sd">    Returns:</span>
<span class="sd">        A connection of the requested type</span>

<span class="sd">    Examples:</span>
<span class="sd">        Basic async connection:</span>

<span class="sd">        &gt;&gt;&gt; connection = create_connection(</span>
<span class="sd">        ...     url=&quot;ws://localhost:8001/rpc&quot;,</span>
<span class="sd">        ...     namespace=&quot;test_ns&quot;,</span>
<span class="sd">        ...     database=&quot;test_db&quot;,</span>
<span class="sd">        ...     username=&quot;root&quot;,</span>
<span class="sd">        ...     password=&quot;root&quot;,</span>
<span class="sd">        ...     make_default=True</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # await connection.connect()  # in async context</span>

<span class="sd">        Sync connection:</span>

<span class="sd">        &gt;&gt;&gt; connection = create_connection(</span>
<span class="sd">        ...     url=&quot;ws://localhost:8001/rpc&quot;,</span>
<span class="sd">        ...     namespace=&quot;test_ns&quot;, </span>
<span class="sd">        ...     database=&quot;test_db&quot;,</span>
<span class="sd">        ...     username=&quot;root&quot;,</span>
<span class="sd">        ...     password=&quot;root&quot;,</span>
<span class="sd">        ...     async_mode=False,</span>
<span class="sd">        ...     make_default=True</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; connection.connect()</span>

<span class="sd">        Connection with pooling:</span>

<span class="sd">        &gt;&gt;&gt; connection = create_connection(</span>
<span class="sd">        ...     url=&quot;ws://localhost:8000/rpc&quot;,</span>
<span class="sd">        ...     namespace=&quot;production&quot;,</span>
<span class="sd">        ...     database=&quot;app_db&quot;,</span>
<span class="sd">        ...     username=&quot;app_user&quot;,</span>
<span class="sd">        ...     password=&quot;secure_password&quot;,</span>
<span class="sd">        ...     use_pool=True,</span>
<span class="sd">        ...     pool_size=20,</span>
<span class="sd">        ...     make_default=True</span>
<span class="sd">        ... )</span>

<span class="sd">        Named connection with context manager:</span>

<span class="sd">        &gt;&gt;&gt; connection = create_connection(</span>
<span class="sd">        ...     url=&quot;ws://db:8000/rpc&quot;,</span>
<span class="sd">        ...     namespace=&quot;test_ns&quot;,</span>
<span class="sd">        ...     database=&quot;test_db&quot;, </span>
<span class="sd">        ...     username=&quot;root&quot;,</span>
<span class="sd">        ...     password=&quot;root&quot;,</span>
<span class="sd">        ...     name=&quot;test_connection&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # async with connection:  # in async context</span>
<span class="sd">        ... #     # Use connection</span>
<span class="sd">        ... #     pass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">async_mode</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">SurrealEngineAsyncConnection</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> 
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> 
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> 
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> 
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> 
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> 
            <span class="n">make_default</span><span class="o">=</span><span class="n">make_default</span><span class="p">,</span>
            <span class="n">use_pool</span><span class="o">=</span><span class="n">use_pool</span><span class="p">,</span>
            <span class="n">pool_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span>
            <span class="n">max_idle_time</span><span class="o">=</span><span class="n">max_idle_time</span><span class="p">,</span>
            <span class="n">connect_timeout</span><span class="o">=</span><span class="n">connect_timeout</span><span class="p">,</span>
            <span class="n">operation_timeout</span><span class="o">=</span><span class="n">operation_timeout</span><span class="p">,</span>
            <span class="n">retry_limit</span><span class="o">=</span><span class="n">retry_limit</span><span class="p">,</span>
            <span class="n">retry_delay</span><span class="o">=</span><span class="n">retry_delay</span><span class="p">,</span>
            <span class="n">retry_backoff</span><span class="o">=</span><span class="n">retry_backoff</span><span class="p">,</span>
            <span class="n">validate_on_borrow</span><span class="o">=</span><span class="n">validate_on_borrow</span><span class="p">,</span>
            <span class="n">health_check_interval</span><span class="o">=</span><span class="n">health_check_interval</span>
        <span class="p">)</span>

        <span class="c1"># Auto-connect if requested</span>
        <span class="k">if</span> <span class="n">auto_connect</span><span class="p">:</span>
            <span class="c1"># We can&#39;t await here, so we&#39;ll return the connection without connecting</span>
            <span class="c1"># The caller will need to await connection.connect() before using it</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">connection</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">SurrealEngineSyncConnection</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> 
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> 
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> 
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> 
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> 
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> 
            <span class="n">make_default</span><span class="o">=</span><span class="n">make_default</span>
        <span class="p">)</span>

        <span class="c1"># Auto-connect if requested</span>
        <span class="k">if</span> <span class="n">auto_connect</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">connection</span></div>



<div class="viewcode-block" id="SurrealEngineSyncConnection">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SurrealEngineSyncConnection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronous connection manager for SurrealDB.</span>

<span class="sd">    This class manages the synchronous connection to a SurrealDB database, providing methods</span>
<span class="sd">    for connecting, disconnecting, and executing transactions. It also provides</span>
<span class="sd">    access to the database through the db property.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        url: The URL of the SurrealDB server</span>
<span class="sd">        namespace: The namespace to use</span>
<span class="sd">        database: The database to use</span>
<span class="sd">        username: The username for authentication</span>
<span class="sd">        password: The password for authentication</span>
<span class="sd">        client: The SurrealDB sync client instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SurrealEngineSyncConnection.__init__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">database</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">make_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new SurrealEngineSyncConnection.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL of the SurrealDB server</span>
<span class="sd">            namespace: The namespace to use</span>
<span class="sd">            database: The database to use</span>
<span class="sd">            username: The username for authentication</span>
<span class="sd">            password: The password for authentication</span>
<span class="sd">            name: The name to register this connection under in the registry</span>
<span class="sd">            make_default: Whether to set this connection as the default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">ConnectionRegistry</span><span class="o">.</span><span class="n">add_sync_connection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">make_default</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ConnectionRegistry</span><span class="o">.</span><span class="n">set_default_sync_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="SurrealEngineSyncConnection.__enter__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.__enter__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SurrealEngineSyncConnection&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enter the sync context manager.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The connection instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="SurrealEngineSyncConnection.__exit__">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.__exit__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span> 
                <span class="n">exc_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span> 
                <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the sync context manager.</span>

<span class="sd">        Args:</span>
<span class="sd">            exc_type: The exception type, if an exception was raised</span>
<span class="sd">            exc_val: The exception value, if an exception was raised</span>
<span class="sd">            exc_tb: The exception traceback, if an exception was raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurrealEngine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dynamic table accessor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SurrealEngine instance for accessing tables dynamically</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SurrealEngine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="SurrealEngineSyncConnection.connect">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to the database.</span>

<span class="sd">        This method creates a new client if one doesn&#39;t exist, signs in if</span>
<span class="sd">        credentials are provided, and sets the namespace and database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The SurrealDB client instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="c1"># Create the client directly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">surrealdb</span><span class="o">.</span><span class="n">Surreal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

            <span class="c1"># Sign in if credentials are provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">signin</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">})</span>

            <span class="c1"># Use namespace and database</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span></div>


<div class="viewcode-block" id="SurrealEngineSyncConnection.disconnect">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.disconnect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disconnect from the database.</span>

<span class="sd">        This method closes the client connection if one exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SurrealEngineSyncConnection.transaction">
<a class="viewcode-back" href="../../api/connection.html#surrealengine.connection.SurrealEngineSyncConnection.transaction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callables</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute multiple operations in a transaction.</span>

<span class="sd">        This method executes a list of callables within a transaction,</span>
<span class="sd">        committing the transaction if all operations succeed or canceling</span>
<span class="sd">        it if any operation fails.</span>

<span class="sd">        Args:</span>
<span class="sd">            callables: List of callables to execute in the transaction</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of results from the callables</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If any operation in the transaction fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;BEGIN TRANSACTION;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">callables</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;COMMIT TRANSACTION;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CANCEL TRANSACTION;&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>
</div>

</pre></div>
</main>
                        
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                    &copy; Copyright 2025, SurrealEngine Contributors
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="../../_static/documentation_options.js?v=b9afe91b"></script>
        <script src="../../_static/doctools.js?v=9bcbadda"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=30646c52"></script>
        <script type="text/javascript" src="../../_static/dist/theme.js"></script>
        <script type="text/javascript" src="../../_static/dist/vendor.js"></script>
        <script type="text/javascript" src="../../_static/searchtools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("../../searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>